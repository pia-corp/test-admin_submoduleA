name: Lighthouse Audit
on:
  pull_request:
    branches:
      - main
    types: [opened, edited, reopened, synchronize]
jobs:
  Lighthouse:
    name: Lighthouse-CI
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Check out repository
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0  # å·®åˆ†ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«å±¥æ­´ã‚’ã™ã¹ã¦å–å¾—
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'latest'
      - name: Install dependencies
        run: npm install
      - name: Get changed HTML files from main
        id: filter_html
        run: |
          git fetch origin main  # mainãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—
          CHANGED_FILES=$(git diff --name-only origin/main)  # mainã¨ã®å·®åˆ†ã‚’å–å¾—
          echo "å·®åˆ†ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ: $CHANGED_FILES" # ãƒ­ã‚°å‡ºåŠ›
          PORT=38533
          BASE_URL="http://localhost:$PORT"
          FILES=()
          # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã†ã¡ .html ã®ã¿ã‚’æŠ½å‡º
          for file in $CHANGED_FILES; do
            if [[ $file == *.html ]]; then
              # publicãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ã®ç›¸å¯¾ãƒ‘ã‚¹ã«å¤‰æ› (public/ ã‚’å‰Šé™¤)
              RELATIVE_FILE_PATH=$(echo "$file" | sed 's|^public/||')
              # publicãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª (å¿µã®ãŸã‚)
              if [[ -f "public/$RELATIVE_FILE_PATH" ]]; then
                FILES+=("\"$BASE_URL/$RELATIVE_FILE_PATH\"")
              else
                echo "warn: publicãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“: $file" # è­¦å‘Šãƒ­ã‚°
              fi
            fi
          done
          echo "æŠ½å‡ºã•ã‚ŒãŸHTMLãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆ: ${FILES[@]}" # ãƒ­ã‚°å‡ºåŠ›
          # JSON é…åˆ—ã«å¤‰æ›
          JSON_FILES=$(printf ",%s" "${FILES[@]}")
          JSON_FILES="[${JSON_FILES:1}]"
          echo "Lighthouseç›£æŸ»å¯¾è±¡URLãƒªã‚¹ãƒˆ: $JSON_FILES" # ãƒ­ã‚°å‡ºåŠ›
          echo "urls=$JSON_FILES" >> $GITHUB_ENV
      - name: Start the server
        run: |
          npx http-server ./public -p 38533 &  # http-serverã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§èµ·å‹•
          sleep 5  # ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã™ã‚‹ã¾ã§å¾…æ©Ÿ
      - name: Run Lighthouse against changed files
        if: env.urls != '[]'
        id: lighthouse_audit
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: ${{ fromJSON(env.urls) }}
          temporaryPublicStorage: true
        continue-on-error: true
      - name: Comment on PR with Lighthouse results
        id: format_lighthouse_score
        uses: actions/github-script@v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const urls = ${{ steps.lighthouse_audit.outputs.links }};
            const assertions =${{ steps.lighthouse_audit.outputs.assertionResults }};
            const manifest = ${{ steps.lighthouse_audit.outputs.manifest }};
            console.log(urls);
            console.log(assertions);
            console.log(manifest);
            // JSONã‹ã‚‰URLã¨ã‚¹ã‚³ã‚¢æƒ…å ±ã‚’æŠ½å‡º
            const scoreData = [];
            // ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‹ã‚‰URLã”ã¨ã®ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã¨ã‚¹ã‚³ã‚¢ã‚’å–å¾—
            for (const item of manifest) {
              const urlKey = item.url;
              const deviceType = item.isDesktop ? 'Desktop' : 'Mobile';
              const reportUrl = urls[urlKey];
              // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—ï¼ˆURLã‹ã‚‰ãƒ‘ã‚¹ã®ã¿ã‚’æŠ½å‡ºï¼‰
              const parsedUrl = new URL(urlKey);
              const fileName = parsedUrl.pathname === '/' ? 'index.html' : parsedUrl.pathname.split('/').pop();
              // å„ã‚«ãƒ†ã‚´ãƒªã®ã‚¹ã‚³ã‚¢ã‚’å–å¾— (summaryã‹ã‚‰ç›´æ¥å–å¾—)
              if (item.summary) {
                const performance = Math.round(item.summary.performance * 100);
                const accessibility = Math.round(item.summary.accessibility * 100);
                const bestPractices = Math.round(item.summary['best-practices'] * 100);
                const seo = Math.round(item.summary.seo * 100);
                scoreData.push({
                  fileName,
                  device: deviceType,
                  performance,
                  accessibility,
                  bestPractices,
                  seo,
                  reportUrl
                });
              }
            }
            // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
            let markdownTable = '## ğŸ” Lighthouse ç›£æŸ»çµæœ\n\n';
            markdownTable += '| File name | Device | Performance | Accessibility | Best Practices | SEO | Report URL |\n';
            markdownTable += '| --------- | ------ | ----------- | ------------- | -------------- | --- | ---------- |\n';
            for (const data of scoreData) {
              // ã‚¹ã‚³ã‚¢ã«åŸºã¥ã„ã¦çµµæ–‡å­—ã‚’è¿½åŠ 
              const getEmojiForScore = (score) => {
                if (score === undefined || score === null) return 'âšªï¸';
                if (score >= 90) return 'ğŸŸ¢';
                if (score >= 50) return 'ğŸŸ ';
                return 'ğŸ”´';
              };
              markdownTable += `| ${data.fileName} | ${data.device} | ${getEmojiForScore(data.performance)} ${data.performance} | ${getEmojiForScore(data.accessibility)} ${data.accessibility} | ${getEmojiForScore(data.bestPractices)} ${data.bestPractices} | ${getEmojiForScore(data.seo)} ${data.seo} | [è©³ç´°](${data.reportUrl}) |\n`;
            }
            // æ¦‚è¦èª¬æ˜ã‚’è¿½åŠ 
            markdownTable += '\n### ã‚¹ã‚³ã‚¢è©•ä¾¡\n';
            markdownTable += '- ğŸŸ¢ 90-100: è‰¯å¥½\n';
            markdownTable += '- ğŸŸ  50-89: æ”¹å–„æ¨å¥¨\n';
            markdownTable += '- ğŸ”´ 0-49: è¦ä¿®æ­£\n';
            // PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
            const prNumber = context.payload.pull_request.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: markdownTable
            });
            console.log('Lighthouseç›£æŸ»çµæœã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆã—ã¾ã—ãŸ');
