name: Lighthouse Audit

on:
  pull_request:
    branches:
      - main
    types: [opened, edited, reopened, synchronize]

jobs:
  Lighthouse:
    name: Lighthouse-CI
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v4.2.2
        with:
          ref: ${{ github.head_ref || github.ref_name }}

      - name: Setup Node.js
        uses: actions/setup-node@v4.2.0
        with:
          node-version: 'latest'

      - name: Install dependencies
        run: |
          npm install -g lighthouse
          sudo apt-get install jq

      - name: Start local server
        run: |
          npx serve -s public -l 8080 &
          echo $! > .server-pid
          sleep 10

      - name: Run Lighthouse
        run: |
          mkdir -p lighthouse-results

      - name: Run Lighthouse against a static dist dir
        run: |
          # publicディレクトリ内のHTMLファイルを自動でリストアップ
          URLS=$(find public -name "*.html" | sed 's|public/||' | sed 's|^|http://localhost:8080/|')

          # 各HTMLページに対してLighthouseを実行
          for url in $URLS; do
            BASENAME=$(basename "$url" .html)  # URLからページ名（例: index, about）を取得
            lighthouse "$url" --view --quiet --chrome-flags="--headless"
          done
