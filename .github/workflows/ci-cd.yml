# =====================================================================
# PageSpeed Insights è‡ªå‹•ãƒã‚§ãƒƒã‚¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# =====================================================================
# æ¦‚è¦:
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«ä»¥ä¸‹ã®å‡¦ç†ã‚’è‡ªå‹•çš„ã«å®Ÿè¡Œã—ã¾ã™:
# 1. ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã¨ç’°å¢ƒè¨­å®š
# 2. HTMLãƒ•ã‚¡ã‚¤ãƒ«ã®æ•´å½¢ï¼ˆlintï¼‰
# 3. é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã¸ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ—ãƒ­ã‚¤
# 4. ãƒªãƒ³ã‚¯åˆ‡ã‚Œã®ãƒã‚§ãƒƒã‚¯
# 5. å¤‰æ›´ã•ã‚ŒãŸHTMLãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã™ã‚‹PageSpeed Insightsã«ã‚ˆã‚‹ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ
# 6. çµæœã®PRã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
#
# ãƒ•ãƒ­ãƒ¼:
# ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆ/æ›´æ–° â†’ ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ â†’ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« â†’
# lintå®Ÿè¡Œ â†’ SSHã‚­ãƒ¼è¨­å®š â†’ ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ—ãƒ­ã‚¤ â†’ ãƒªãƒ³ã‚¯ãƒã‚§ãƒƒã‚¯ â†’
# HTMLå·®åˆ†æŠ½å‡º â†’ PSIãƒã‚§ãƒƒã‚¯ â†’ çµæœæŠ•ç¨¿
#
# æ³¨æ„äº‹é …:
# - ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯`develop/`ãƒ–ãƒ©ãƒ³ãƒã¸ã®PRã«å¯¾ã—ã¦ã®ã¿å®Ÿè¡Œã•ã‚Œã¾ã™
# - SSHæ¥ç¶šã®ãŸã‚ã®ç§˜å¯†éµã¯GitHubã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‹ã‚‰å–å¾—ã—ã¾ã™
# - PSI APIã‚­ãƒ¼ã¯GitHubã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã«è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
# - å‡¦ç†æ™‚é–“åˆ¶é™ã¯30åˆ†ã§ã™
# =====================================================================

name: PageSpeed Insights åˆ†æ

on:
  pull_request:
    branches:
      - 'main'
    types: [opened, reopened, synchronize]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  page_speed_analysis:
    name: ãƒ‡ãƒ—ãƒ­ã‚¤ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: startsWith(github.head_ref, 'develop')

    # =============================
    # ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
    # - GitHubå¤‰æ•°ã‹ã‚‰ç’°å¢ƒè¨­å®šã‚’å–å¾—
    # - å‡ºåŠ›å€¤ã®å®šç¾©
    # =============================
    outputs:
      html_files: ${{ steps.extract_html_diff.outputs.html_files }}
      html_count: ${{ steps.extract_html_diff.outputs.html_count }}

    env:
      # æ¥ç¶šæƒ…å ±
      SERVER_HOST: ${{ vars.DEVELOPMENT_HOST }}
      SERVER_PORT: ${{ vars.DEVELOPMENT_PORT }}
      SERVER_USER: ${{ vars.DEVELOPMENT_USER_NAME }}

      # ãƒ‘ã‚¹è¨­å®š
      LOCAL_PATH: ${{ vars.LOCAL_PATH }}
      REMOTE_BASE_PATH: ${{ vars.DEVELOPMENT_REMOTE_PATH }}
      REMOTE_PROJECT_PATH: ${{ vars.DEVELOPMENT_REMOTE_PATH }}/${{ github.event.repository.name }}

      # ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š
      SYNC_MODE: "full"
      TARGET_REPOSITORY: ${{ github.event.repository.name }}
      TARGET_ENVIRONMENT: "æ¤œè¨¼ç’°å¢ƒ"

    steps:
      # =============================
      # åŸºæœ¬è¨­å®š
      # =============================
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4.2.2

      - name: Node.jsç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4.3.0
        with:
          node-version: 'latest'

      - name: npmä¾å­˜é–¢ä¿‚ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        uses: actions/cache@v4.2.3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      # - name: ãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—ãƒªãƒ³ãƒˆ
      #   run: npm run linter

      # # =============================
      # # SSHè¨­å®šã¨ãƒ‡ãƒ—ãƒ­ã‚¤
      # # =============================
      # - name: SSHç§˜å¯†éµã‚’è¨­å®š
      #   run: |
      #     # SSHãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
      #     if [ ! -d "~/.ssh" ]; then
      #       mkdir -p ~/.ssh
      #     fi

      #     # ç§˜å¯†éµã‚’è¨­å®š
      #     echo "${{ secrets.DEVELOPMENT_SSH_KEY }}" > ~/.ssh/id_rsa.enc
      #     echo "${{ secrets.SSH_PASSPHRASE }}" | openssl rsa -in ~/.ssh/id_rsa.enc -out ~/.ssh/id_rsa
      #     chmod 600 ~/.ssh/id_rsa

      #     # SSHè¨­å®šã‚’ä½œæˆ
      #     echo -e "Host ${{ env.SERVER_HOST }}\n  User ${{ env.SERVER_USER }}\n  Port ${{ env.SERVER_PORT }}\n  IdentityFile ~/.ssh/id_rsa\n" > ~/.ssh/config

      #     # ãƒªãƒ¢ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
      #     ssh -v -p ${{ env.SERVER_PORT }} -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "mkdir -p ${{ env.REMOTE_PROJECT_PATH }}"

      # - name: æ¤œè¨¼ç’°å¢ƒã¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
      #   uses: milanmk/actions-file-deployer@1.16
      #   with:
      #     remote-protocol: 'sftp'
      #     remote-host: ${{ env.SERVER_HOST }}
      #     remote-port: ${{ env.SERVER_PORT }}
      #     remote-user: ${{ env.SERVER_USER }}
      #     ssh-private-key: ~/.ssh/id_rsa
      #     local-path: ${{ env.LOCAL_PATH }}
      #     remote-path: ${{ env.REMOTE_PROJECT_PATH }}
      #     sync: ${{ env.SYNC_MODE }}
      #     debug: false

      # =============================
      # ãƒªãƒ³ã‚¯ãƒã‚§ãƒƒã‚¯
      # =============================
  check-links:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Install dependencies
        run: npm install broken-link-checker cheerio

      - name: Create link checker script
        run: |
          cat > check-links.js << 'EOF'
          const { promisify } = require('util');
          const fs = require('fs');
          const path = require('path');
          const blc = require('broken-link-checker');
          const cheerio = require('cheerio');

          const readdir = promisify(fs.readdir);
          const readFile = promisify(fs.readFile);
          const writeFile = promisify(fs.writeFile);
          const stat = promisify(fs.stat);

          // HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†å¸°çš„ã«æ¤œç´¢ã™ã‚‹é–¢æ•°
          async function findHtmlFiles(dir) {
            const files = await readdir(dir);
            const htmlFiles = [];

            for (const file of files) {
              const filePath = path.join(dir, file);
              const stats = await stat(filePath);

              if (stats.isDirectory()) {
                const subDirFiles = await findHtmlFiles(filePath);
                htmlFiles.push(...subDirFiles);
              } else if (file.endsWith('.html')) {
                htmlFiles.push(filePath);
              }
            }

            return htmlFiles;
          }

          // ä¸€ã¤ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªãƒ³ã‚¯ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°
          function checkFileLinks(filePath) {
            return new Promise(async (resolve) => {
              const brokenLinks = [];
              const fileContent = await readFile(filePath, 'utf-8');
              const $ = cheerio.load(fileContent);
              let pendingLinks = 0;
              let completed = false;

              // ã™ã¹ã¦ã®aã‚¿ã‚°ã®hrefå±æ€§ã‚’å–å¾—
              const links = $('a').map((i, el) => $(el).attr('href')).get()
                .filter(href => href && !href.startsWith('#') && !href.startsWith('mailto:') && !href.startsWith('tel:'));

              if (links.length === 0) {
                return resolve({ filePath, brokenLinks: [] });
              }

              // ç›¸å¯¾ãƒ‘ã‚¹ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ã‚¹ã«å¤‰æ›
              const urlChecker = new blc.HtmlUrlChecker(
                { honorRobotExclusions: false, excludeExternalLinks: false },
                {
                  link: (result) => {
                    if (result.broken) {
                      brokenLinks.push({
                        url: result.url.original,
                        reason: result.brokenReason
                      });
                    }
                    pendingLinks--;
                    if (pendingLinks === 0 && completed) {
                      resolve({ filePath, brokenLinks });
                    }
                  },
                  complete: () => {
                    completed = true;
                    if (pendingLinks === 0) {
                      resolve({ filePath, brokenLinks });
                    }
                  }
                }
              );

              pendingLinks = links.length;
              for (const link of links) {
                let url = link;
                if (!url.startsWith('http') && !url.startsWith('file://')) {
                  // ç›¸å¯¾ãƒ‘ã‚¹ã‚’çµ¶å¯¾ãƒ‘ã‚¹ã«å¤‰æ›
                  const baseDir = path.dirname(filePath);
                  url = `file://${path.resolve(baseDir, url)}`;
                }
                urlChecker.enqueue(url);
              }
            });
          }

          async function main() {
            try {
              // publicãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ã™ã¹ã¦ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
              const htmlFiles = await findHtmlFiles('public');
              console.log(`${htmlFiles.length} HTMLãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`);

              // ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªãƒ³ã‚¯ã‚’ä¸¦è¡Œã—ã¦ãƒã‚§ãƒƒã‚¯
              const results = await Promise.all(htmlFiles.map(file => checkFileLinks(file)));

              // å£Šã‚ŒãŸãƒªãƒ³ã‚¯ãŒã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
              const filesWithBrokenLinks = results.filter(result => result.brokenLinks.length > 0);

              // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã§çµæœã‚’å‡ºåŠ›
              let markdown = '| ãƒ•ã‚¡ã‚¤ãƒ«å | ãƒªãƒ³ã‚¯åˆ‡ã‚Œãƒ‘ã‚¹ |\n|----------|-------------|\n';
              let hasBrokenLinks = false;

              for (const result of filesWithBrokenLinks) {
                for (const link of result.brokenLinks) {
                  hasBrokenLinks = true;
                  markdown += `| ${result.filePath} | ${link.url} |\n`;
                }
              }

              // çµæœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãè¾¼ã¿
              if (hasBrokenLinks) {
                await writeFile('broken_links_result.md', markdown);
                console.log('::set-output name=found_broken_links::true');
              } else {
                await writeFile('broken_links_result.md', 'ãƒªãƒ³ã‚¯åˆ‡ã‚Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                console.log('::set-output name=found_broken_links::false');
              }
            } catch (error) {
              console.error('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
              process.exit(1);
            }
          }

          main();
          EOF

      - name: Check for broken links
        id: blc
        run: |
          node check-links.js
          if grep -q "| " broken_links_result.md; then
            echo "found_broken_links=true" >> $GITHUB_OUTPUT
          else
            echo "found_broken_links=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR
        if: steps.blc.outputs.found_broken_links == 'true'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const brokenLinksContent = fs.readFileSync('broken_links_result.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ” ãƒªãƒ³ã‚¯åˆ‡ã‚ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ\n\n${brokenLinksContent}\n\nã“ã‚Œã‚‰ã®ãƒªãƒ³ã‚¯ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚`
            });





      # =============================
      # HTMLå¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æŠ½å‡º
      # =============================
      - name: å¤‰æ›´ã•ã‚ŒãŸHTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŠ½å‡º
        id: extract_html_diff
        run: |
          # mainãƒ–ãƒ©ãƒ³ãƒã¨æ¯”è¼ƒã™ã‚‹ãŸã‚ã«fetch
          git fetch origin || true

          # HTMLãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’æŠ½å‡ºï¼ˆpublicé…ä¸‹ã®ã¿ï¼‰
          HTML_FILES=$(git diff --name-only origin/main HEAD | grep -E 'public/.*\.html$' | sed 's#^public/##g' | tr '\n' ',' || echo "")

          # æœ«å°¾ã®ã‚«ãƒ³ãƒã‚’å‰Šé™¤
          HTML_FILES=${HTML_FILES%,}

          # çµæœã®å‡¦ç†
          if [ -n "$HTML_FILES" ]; then
            HTML_COUNT=$(echo "$HTML_FILES" | awk -F',' '{print NF}')
            echo "å¤‰æ›´ã•ã‚ŒãŸHTMLãƒ•ã‚¡ã‚¤ãƒ«: $HTML_FILES"
          else
            echo "å¤‰æ›´ã•ã‚ŒãŸHTMLãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“"
            HTML_FILES=""
            HTML_COUNT=0
          fi

          # å‡ºåŠ›ã‚’è¨­å®š
          echo "html_files=${HTML_FILES}" >> $GITHUB_OUTPUT
          echo "html_count=${HTML_COUNT}" >> $GITHUB_OUTPUT

      # =============================
      # PageSpeed Insightsåˆ†æ
      # =============================
      - name: PageSpeed Insightsåˆ†æã‚’å®Ÿè¡Œ
        env:
          PSI_API_KEY: ${{ secrets.PSI_API_KEY }}
          BASE_URL: "https://piapiapia.xsrv.jp/dev/${{ github.event.repository.name }}"
          HTML_FILES: ${{ steps.extract_html_diff.outputs.html_files }}
        id: psi_check
        run: |
          echo "åˆ†æå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«: ${{ steps.extract_html_diff.outputs.html_files }}"
          RESULT=$(node .github/actions/psi)
          echo "result<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: PSIåˆ†æçµæœã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
        uses: actions/github-script@v7.0.1
        if: ${{ steps.psi_check.outcome == 'success' }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const result = `${{ steps.psi_check.outputs.result }}`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: result
            });
