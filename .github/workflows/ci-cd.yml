name: CI

on:
  pull_request:
    branches:
      - 'main'
    types: [opened, reopened, synchronize]

# åŒã˜PRã§è¤‡æ•°ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Ÿè¡Œã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹è¨­å®š
# æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸå ´åˆã€é€²è¡Œä¸­ã®å¤ã„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯è‡ªå‹•çš„ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã‚‹
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

jobs:
  # =============================
  # HTMLãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã—ã¦markuplintã«ã‚ˆã‚‹é™çš„è§£æã‚’å®Ÿè¡Œã—ã€ã‚³ãƒ¼ãƒ‰ã®å“è³ªã‚’æ¤œè¨¼ã—ã¾ã™ã€‚
  # =============================
  html-linter:
    name: HTMLãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—ãƒªãƒ³ã‚¿ãƒ¼
    # å®Ÿè¡Œæ¡ä»¶ï¼š
    # - ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒãŒmain
    # - å®Ÿè¡Œè€…ãŒdependabotã§ã¯ãªã„
    # - ãƒ˜ãƒƒãƒ‰ãƒ–ãƒ©ãƒ³ãƒåãŒdevelopã§å§‹ã¾ã‚‹
    if: github.base_ref == 'main' && github.actor != 'dependabot[bot]' && startsWith(github.head_ref, 'develop')

    runs-on: ubuntu-latest
    # å®Ÿè¡Œæ™‚é–“ãŒ3åˆ†ã‚’è¶…ãˆãŸå ´åˆã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å¼·åˆ¶çµ‚äº†
    timeout-minutes: 3
    # å¿…è¦ãªæ¨©é™ã®ã¿ã‚’ä»˜ä¸
    permissions:
      contents: read         # ãƒªãƒã‚¸ãƒˆãƒªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®èª­ã¿å–ã‚Šæ¨©é™
      pull-requests: write   # PRã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿æ¨©é™

    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false  # ä¸è¦ãªèªè¨¼æƒ…å ±ã‚’ä¿æŒã—ãªã„

      # Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Node.jsã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@cdca7365b2dadb8aad0a33bc7601856ffabcc48e # v3.5.1
        with:
          node-version: 'latest'  # æœ€æ–°ã®Node.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ç”¨

      # ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: npm ci

      - name: Run markuplint # markuplintã‚’å®Ÿè¡Œã—ã€çµæœã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›
        id: run-markuplint
        # publicãƒ•ã‚©ãƒ«ãƒ€å†…ã®htmlãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¯¾è±¡ã¨ã™ã‚‹ (--format jsonã§JSONå½¢å¼å‡ºåŠ›)
        # å•é¡ŒãŒã‚ã£ã¦ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç¶šè¡Œã•ã›ã‚‹ãŸã‚ã« continue-on-error: true ã‚’è¨­å®š
        run: |
          npx markuplint public/**/*.html --format json > markuplint-results.json || true
          # npm run markuplint -- public/**/*.html --format json > markuplint-results.json || true
        continue-on-error: true # lintã‚¨ãƒ©ãƒ¼ã§ã‚¸ãƒ§ãƒ–ãŒå¤±æ•—ã—ãªã„ã‚ˆã†ã«ã™ã‚‹

      - name: Dump markuplint results # ãƒ‡ãƒãƒƒã‚°ç”¨ã‚¹ãƒ†ãƒƒãƒ—
        run: |
          echo "--- markuplint-results.json content ---"
          cat markuplint-results.json || echo "markuplint-results.json not found or empty"
          echo "--- end of content ---"

      - name: Create Comment Body # ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã‚’ä½œæˆ
        id: create-comment
        # markuplintã®ã‚¹ãƒ†ãƒƒãƒ—ãŒæˆåŠŸã—ãŸã‹ã€ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚ç¶šè¡Œã•ã‚ŒãŸå ´åˆã«å®Ÿè¡Œ
        if: steps.run-markuplint.outcome == 'success' || steps.run-markuplint.outcome == 'failure'
        run: |
          # ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã€ç©ºã§ãªã„ã“ã¨ã‚’ç¢ºèª
          if [ ! -s markuplint-results.json ]; then
            echo "markuplint-results.json is empty or not found. Assuming no violations."
            echo "COMMENT_BODY=No markuplint violations found or analysis could not be run." >> $GITHUB_ENV
            exit 0
          fi

          results=$(cat markuplint-results.json)

          # results ãŒæœ‰åŠ¹ãªJSONã‹ãƒã‚§ãƒƒã‚¯
          if ! echo "$results" | jq empty > /dev/null 2>&1; then
            echo "Error: markuplint-results.json does not contain valid JSON."
            echo "Output:"
            cat markuplint-results.json
            echo "COMMENT_BODY=Error processing markuplint results (invalid JSON)." >> $GITHUB_ENV
            exit 0 # ã¾ãŸã¯ exit 1
          fi

          # çµæœãŒé…åˆ—ãªã®ã§ã€jq '.' ã§ç›´æ¥é…åˆ—ã‚’å–å¾—ã™ã‚‹
          violations_array=$(echo "$results" | jq '.')

          # é…åˆ—å½¢å¼ã§ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ (å¿µã®ãŸã‚)
          if [ "$violations_array" == "null" ] || ! echo "$violations_array" | jq 'type == "array"' | grep -q true; then
              echo "Error: Could not extract violations array from markuplint results."
              echo "Result content:"
              cat markuplint-results.json
              echo "COMMENT_BODY=Error processing markuplint results (unexpected format)." >> $GITHUB_ENV
              exit 0 # ã¾ãŸã¯ exit 1
          fi

          if [ "$(echo "$violations_array" | jq 'length')" -eq 0 ]; then
            echo "No violations found."
            echo "COMMENT_BODY=No markuplint violations found." >> $GITHUB_ENV
          else
            echo "Violations found. Generating comment..."
            # --- ã“ã“ã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã«å¤‰æ›´ ---
            # jq ã§å„é•åã‚’ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œã«å¤‰æ›ã—ã€æ”¹è¡Œã§çµåˆ
            # filePath ã‹ã‚‰ ".*/public/" ã«ä¸€è‡´ã™ã‚‹éƒ¨åˆ†ã‚’å‰Šé™¤ã—ã¦è¡¨ç¤º
            table_rows=$(echo "$violations_array" | jq -r '
              map("| \(.line // "?"):\(.col // "?") | `\(.filePath // "N/A" | sub(".*/public/"; ""))` | `\(.ruleId // "N/A")` | \(.message // "N/A" | gsub("\\|"; "\\\\|")) |") | .[]'
            )

            comment_body=`
              ### :warning: Markuplint Violations Found
              | Line | File | Rule | Message |
              |------|------|------|---------|
              ${table_rows}
            `;
            # --- ã“ã“ã¾ã§ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã«å¤‰æ›´ ---

            # ç’°å¢ƒå¤‰æ•°ã«è¨­å®š (è¤‡æ•°è¡Œå¯¾å¿œ)
            echo 'COMMENT_BODY<<EOF' >> $GITHUB_ENV
            echo "$comment_body" >> $GITHUB_ENV # -e ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯å¿…é ˆã§ã¯ãªã„ã“ã¨ãŒå¤šã„
            echo 'EOF' >> $GITHUB_ENV
          fi
        shell: bash {0}

      # - name: Install jq # jqã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆã«å¿…è¦)
      #   if: steps.create-comment.outputs.COMMENT_BODY != '' && steps.create-comment.outputs.COMMENT_BODY != 'No markuplint violations found.' # å•é¡ŒãŒã‚ã£ãŸå ´åˆã®ã¿å®Ÿè¡Œ
      #   run: sudo apt-get update && sudo apt-get install -y jq


      - name: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
        # ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ãŒå­˜åœ¨ã—ã€ã‹ã¤ "No violations found." ã§ãªã„å ´åˆã®ã¿å®Ÿè¡Œ
        if: env.COMMENT_BODY != '' && env.COMMENT_BODY != 'No markuplint violations found.'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentBody = process.env.COMMENT_BODY;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number, // ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ç•ªå·
              body: commentBody
            });

      # - name: Error handling
      #   if: ${{ steps.markuplint.outcome == 'failure' }}
      #   run: |
      #     echo $
      #     exit 1
      #     continue-on-error: true

      # - name: Comment on PR
      #   if: env.ERROR_COUNT != '0'
      #   uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
      #   with:
      #     github-token: ${{ secrets.GITHUB_TOKEN }}
      #     script: |
      #       const fs = require('fs');

      #       const comment = `# Markuplint æ¤œæŸ»çµæœ ğŸ”

      #       ${process.env.COMMENT}

      #       è©³ç´°ã¯ [markuplint ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://markuplint.dev/) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚`;

      #       github.rest.issues.createComment({
      #         issue_number: context.issue.number,
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         body: comment
      #       });

  # =============================
  # ãƒªãƒã‚¸ãƒˆãƒªå†…ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªãƒ³ã‚¯åˆ‡ã‚Œã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚è¦‹ã¤ã‹ã£ãŸãƒªãƒ³ã‚¯åˆ‡ã‚Œã¯ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦å ±å‘Šã•ã‚Œã¾ã™ã€‚
  # =============================
  check-links:
    needs: html-linter
    name: ãƒªãƒ³ã‚¯åˆ‡ã‚Œãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    # å®Ÿè¡Œæ™‚é–“ãŒ5åˆ†ã‚’è¶…ãˆãŸå ´åˆã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å¼·åˆ¶çµ‚äº†
    timeout-minutes: 5
    # å¿…è¦ãªæ¨©é™ã®ã¿ã‚’ä»˜ä¸
    permissions:
      contents: read         # ãƒªãƒã‚¸ãƒˆãƒªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®èª­ã¿å–ã‚Šæ¨©é™
      pull-requests: write   # PRã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿æ¨©é™

    # =============================
    # ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
    # - ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ç•°ãªã‚‹ã‚½ãƒ¼ã‚¹ã‹ã‚‰å€¤ã‚’å–å¾—
    # - å¿…è¦ã«å¿œã˜ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
    # =============================
    env:
      REPOSITORY_NAME: ${{ github.event.repository.name }}

    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false  # ä¸è¦ãªèªè¨¼æƒ…å ±ã‚’ä¿æŒã—ãªã„

      # Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Node.jsã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@cdca7365b2dadb8aad0a33bc7601856ffabcc48e # v3.5.1
        with:
          node-version: 'latest'  # æœ€æ–°ã®Node.jsãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ç”¨

      # ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: npm ci

      # ãƒ­ãƒ¼ã‚«ãƒ«HTTPã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ï¼ˆãƒªãƒ³ã‚¯ãƒã‚§ãƒƒã‚¯ã®ãŸã‚ï¼‰
      - name: Start local server
        run: |
          npx http-server ./public -p 8081 &
          sleep 5

      # ãƒªãƒ³ã‚¯ãƒã‚§ãƒƒã‚«ãƒ¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
      - name: Run link checker
        id: link-checker
        run: |
          cp .github/actions/link-checker.js .
          node link-checker.js

      # è¦‹ã¤ã‹ã£ãŸãƒªãƒ³ã‚¯åˆ‡ã‚Œã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
      - name: Post broken links to PR
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const errorsArray = ${{ steps.link-checker.outputs.errors }}

            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ•´å½¢
            let message = "";
            for (let key in errorsArray) {
              for (let i = 0, len = errorsArray[key].length; i < len; i++) {
                message += `| ${key} | ${errorsArray[key][i]} |\n`;
              }
            }

            const comment = `
              ## ãƒªãƒ³ã‚¯åˆ‡ã‚Œãƒ¬ãƒãƒ¼ãƒˆ
              | ãƒ•ã‚¡ã‚¤ãƒ«å | ãƒªãƒ³ã‚¯åˆ‡ã‚Œãƒ‘ã‚¹ |
              | :-- | :-- |
              ${message}

              ## æ³¨æ„
              ãƒ»ãƒªãƒ³ã‚¯åˆ‡ã‚Œã¯æœ€å¤§100ä»¶ã¾ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
            `;
            github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.issue.number,
              body: comment
            });

  # =============================
  # æ¤œè¨¼ç’°å¢ƒã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸURLã§PSIã‚’å®Ÿè¡Œã—ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æã‚’è¡Œã„ã¾ã™ã€‚
  # =============================
  page_speed_analysis:
    needs: check-links
    name: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ
    runs-on: ubuntu-latest
    # å®Ÿè¡Œæ™‚é–“ãŒ30åˆ†ã‚’è¶…ãˆãŸå ´åˆã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å¼·åˆ¶çµ‚äº†
    timeout-minutes: 30
    permissions:
      contents: read         # ãƒªãƒã‚¸ãƒˆãƒªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®èª­ã¿å–ã‚Šæ¨©é™
      pull-requests: write   # PRã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿æ¨©é™

    # =============================
    # ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
    # - GitHubå¤‰æ•°ã‹ã‚‰ç’°å¢ƒè¨­å®šã‚’å–å¾—
    # - å‡ºåŠ›å€¤ã®å®šç¾©
    # =============================
    outputs:
      html_files: ${{ steps.extract_html_diff.outputs.html_files }}
      html_count: ${{ steps.extract_html_diff.outputs.html_count }}

    env:
      # æ¥ç¶šæƒ…å ±
      DEV_SERVER_HOST: ${{ vars.DEVELOPMENT_HOST }}
      DEV_SERVER_PORT: ${{ vars.DEVELOPMENT_PORT }}
      DEV_SERVER_USER: ${{ vars.DEVELOPMENT_USER_NAME }}

      # ãƒ‘ã‚¹è¨­å®š
      LOCAL_SOURCE_PATH: ${{ vars.LOCAL_PATH }}
      REMOTE_PROJECT_PATH: ${{ vars.DEVELOPMENT_REMOTE_PATH }}/${{ github.event.repository.name }}

      # ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š
      SYNC_MODE: ${{ vars.SYNC_MODE }}

    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false  # ä¸è¦ãªèªè¨¼æƒ…å ±ã‚’ä¿æŒã—ãªã„

      - name: SSHæ¥ç¶šã®è¨­å®š
        run: |
          # SSHãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æº–å‚™
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼šç’°å¢ƒå¤‰æ•°ã®äº‹å‰ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ - ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ”»æ’ƒå¯¾ç­–
          # ãƒ›ã‚¹ãƒˆåã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå³æ ¼ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã¿è¨±å¯ï¼‰
          if ! [[ "${{ env.DEV_SERVER_HOST }}" =~ ^[a-zA-Z0-9][a-zA-Z0-9.-]{0,61}[a-zA-Z0-9](\.[a-zA-Z]{2,})+$ ]]; then
            echo "ã‚¨ãƒ©ãƒ¼: ç„¡åŠ¹ãªã‚µãƒ¼ãƒãƒ¼ãƒ›ã‚¹ãƒˆåãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã™" >&2
            exit 1
          fi
          VALIDATED_HOST="${{ env.DEV_SERVER_HOST }}"

          # ãƒãƒ¼ãƒˆç•ªå·ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ•°å€¤ã®ã¿ã€ç¯„å›²ãƒã‚§ãƒƒã‚¯ï¼‰
          if ! [[ "${{ env.DEV_SERVER_PORT }}" =~ ^[0-9]+$ ]] || \
            [ "${{ env.DEV_SERVER_PORT }}" -lt 1 ] || \
            [ "${{ env.DEV_SERVER_PORT }}" -gt 65535 ]; then
            echo "ã‚¨ãƒ©ãƒ¼: ç„¡åŠ¹ãªãƒãƒ¼ãƒˆç•ªå·ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã™" >&2
            exit 1
          fi
          VALIDATED_PORT="${{ env.DEV_SERVER_PORT }}"

          # ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆè‹±æ•°å­—ã¨ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿ï¼‰
          if ! [[ "${{ env.DEV_SERVER_USER }}" =~ ^[a-zA-Z0-9_]+$ ]]; then
            echo "ã‚¨ãƒ©ãƒ¼: ç„¡åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã™" >&2
            exit 1
          fi
          VALIDATED_USER="${{ env.DEV_SERVER_USER }}"

          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‘ã‚¹ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå®‰å…¨ãªæ–‡å­—ã®ã¿ï¼‰
          SANITIZED_PATH=$(echo "${{ env.REMOTE_PROJECT_PATH }}" | sed 's/[^a-zA-Z0-9_/-]//g')
          # è¿½åŠ ãƒã‚§ãƒƒã‚¯ - ç©ºæ–‡å­—åˆ—ã‚„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«ã®é˜²æ­¢
          if [ -z "$SANITIZED_PATH" ] || [[ "$SANITIZED_PATH" == *".."* ]]; then
            echo "ã‚¨ãƒ©ãƒ¼: ç„¡åŠ¹ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‘ã‚¹ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã™" >&2
            exit 1
          fi

          # ç§˜å¯†éµã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
          echo "${{ secrets.DEVELOPMENT_SSH_KEY }}" > ~/.ssh/id_rsa.enc
          echo "${{ secrets.SSH_PASSPHRASE }}" | openssl rsa -in ~/.ssh/id_rsa.enc -out ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # SSHè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ - ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ä»£ã‚ã‚Šã«è¤‡æ•°ã®echoã‚’ä½¿ç”¨
          echo "Host ${VALIDATED_HOST}" > ~/.ssh/config
          echo "  User ${VALIDATED_USER}" >> ~/.ssh/config
          echo "  Port ${VALIDATED_PORT}" >> ~/.ssh/config
          echo "  IdentityFile ~/.ssh/id_rsa" >> ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config

          # SSHã‚³ãƒãƒ³ãƒ‰ã®å®‰å…¨ãªæ§‹ç¯‰ - å¼•æ•°ã®åˆ†é›¢ã¨ã‚¯ã‚©ãƒ¼ãƒˆã«æ³¨æ„
          ssh -p "${VALIDATED_PORT}" \
              -o StrictHostKeyChecking=no \
              -i ~/.ssh/id_rsa \
              "${VALIDATED_USER}@${VALIDATED_HOST}" \
              "mkdir -p '${SANITIZED_PATH}'"

      # ãƒ‡ãƒ—ãƒ­ã‚¤å‡¦ç†
      - name: æ¤œè¨¼ç’°å¢ƒã¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
        uses: milanmk/actions-file-deployer@3cf188f493103b5f12f11221186f8fbd07f2be10 # 1.16
        with:
          remote-protocol: 'sftp'
          remote-host: ${{ env.DEV_SERVER_HOST }}
          remote-port: ${{ env.DEV_SERVER_PORT }}
          remote-user: ${{ env.DEV_SERVER_USER }}
          ssh-private-key: ~/.ssh/id_rsa
          local-path: ${{ env.LOCAL_SOURCE_PATH }}
          remote-path: ${{ env.REMOTE_PROJECT_PATH }}
          sync: ${{ env.SYNC_MODE }}
          debug: false

      # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«åˆ†æ
      - name: å¤‰æ›´ã•ã‚ŒãŸHTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŠ½å‡º
        id: extract_html_diff
        run: |
          # mainãƒ–ãƒ©ãƒ³ãƒã¨æ¯”è¼ƒã™ã‚‹ãŸã‚ã«fetch
          git fetch origin main || echo "mainãƒ–ãƒ©ãƒ³ãƒã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ–°è¦ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆã¯ç„¡è¦–ã§ãã¾ã™ã€‚"

          # publicãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’æŠ½å‡º
          HTML_FILES=$(git diff --name-only origin/main HEAD | grep -E 'public/.*\.html$' | sed 's#^public/##g' | tr '\n' ',' || echo "")

          # æœ«å°¾ã®ã‚«ãƒ³ãƒã‚’å‰Šé™¤
          HTML_FILES=${HTML_FILES%,}

          # çµæœã®å‡¦ç†
          if [ -n "$HTML_FILES" ]; then
            HTML_COUNT=$(echo "$HTML_FILES" | awk -F',' '{print NF}')
            echo "å¤‰æ›´ã•ã‚ŒãŸHTMLãƒ•ã‚¡ã‚¤ãƒ«: $HTML_FILES (åˆè¨ˆ: $HTML_COUNTä»¶)"
          else
            echo "å¤‰æ›´ã•ã‚ŒãŸHTMLãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“"
            HTML_FILES=""
            HTML_COUNT=0
          fi

          # GitHub Actionså‡ºåŠ›ã‚’è¨­å®š
          echo "html_files=${HTML_FILES}" >> $GITHUB_OUTPUT
          echo "html_count=${HTML_COUNT}" >> $GITHUB_OUTPUT

      # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ
      - name: PageSpeed Insightsåˆ†æã‚’å®Ÿè¡Œ
        if: ${{ steps.extract_html_diff.outputs.html_count != '0' }}
        env:
          PSI_API_KEY: ${{ secrets.PSI_API_KEY }}
          BASE_URL: "https://piapiapia.xsrv.jp/dev/${{ github.event.repository.name }}"
          HTML_FILES: ${{ steps.extract_html_diff.outputs.html_files }}
        id: psi_analysis
        run: |
          echo "åˆ†æå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«: ${{ steps.extract_html_diff.outputs.html_files }}"
          RESULT=$(node .github/actions/psi)
          echo "result<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # çµæœã®å ±å‘Š
      - name: PSIåˆ†æçµæœã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
        if: ${{ steps.extract_html_diff.outputs.html_count != '0' && steps.psi_analysis.outcome == 'success' }}
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const result = `${{ steps.psi_analysis.outputs.result }}`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: result
            });
