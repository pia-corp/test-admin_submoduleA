name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  check_links:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'latest'

      - name: Install dependencies
        run: npm install

      - name: Start server
        run: npm start &
        env:
          CI: true

      - name: Run link checker
        run: node link-checker.js
        env:
          GITHUB_OUTPUT: ${{ github.output }}

      - name: Display broken links
        run: echo "${{ steps.link-checker.outputs.errors }}"





# name: CI/CD Pipeline

# on:
#   push:
#     branches:
#       - main
#   pull_request:
#     branches:
#       - main

# jobs:
#   lint:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Set up Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: 'latest'

#       - name: Install dependencies
#         run: npm install

#       - name: Run HTMLHint
#         run: npx htmlhint public/**/*.html

#   link-check:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Set up Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: 'latest'

#       - name: Install dependencies
#         run: npm install

#       - name: Run link checker
#         id: linkchecker_step
#         run: |
#           # curl https://htmltest.wjdp.uk | sudo bash -s -- -b /usr/local/bin
#           # npx http-server -p 8080 &
#           # node link-checker.js

#       - name: Run htmltest
#         id: htmltest
#         uses: wjdp/htmltest-action@master
#         with:
#           path: public
#           config: .htmltest.yml
#         continue-on-error: true

#       - name: Extract internal link errors
#         run: |
#           # HTMLTEST_LOG ã‚’å–å¾—
#           HTMLTEST_LOG=$(cat $GITHUB_WORKSPACE/htmltest.log)

#           # å†…éƒ¨ãƒªãƒ³ã‚¯ã‚¨ãƒ©ãƒ¼ã®ã¿æŠ½å‡ºï¼ˆ"target does not exist" ã‹ã¤ http ã‚’å«ã¾ãªã„ï¼‰
#           INTERNAL_ERRORS=$(echo "$HTMLTEST_LOG" | grep -E 'target does not exist' | grep -v 'http' || true)

#           # GITHUB_OUTPUT ã«è¨­å®š
#           echo "internal_link_errors<<EOF" >> $GITHUB_ENV
#           echo "$INTERNAL_ERRORS" >> $GITHUB_ENV
#           echo "EOF" >> $GITHUB_ENV

#       - name: Show Internal Link Errors
#         run: echo "$internal_link_errors"



#       - name: Use link checker Output
#         run: |
#           echo "link checker result string: ${{ steps.linkchecker_step.outputs.resultString }}" >> $GITHUB_OUTPUT

#       - name: Annotate broken links
#         if: always()
#         run: |
#           if [ -f /tmp/github_output ]; then
#             while IFS= read -r line; do
#               echo "::error file=link-checker.js::Broken link detected: $line"
#             done < /tmp/github_output
#           fi

#   lighthouse:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Set up Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: 'latest'

#       - name: Install dependencies
#         run: npm install

#       - name: Start Server
#         run: npx http-server -p 8080 &

#       - name: Check Server Availability
#         run: |
#           sleep 5 # ã‚µãƒ¼ãƒãƒ¼ãŒå®Œå…¨ã«èµ·å‹•ã™ã‚‹ã®ã‚’å¾…ã¤
#           curl -I http://localhost:8080 || exit 1

#       - name: Run Lighthouse with security bypass
#         id: extract_scores
#         run: |
#           lighthouse http://localhost:8080 \
#             --output=json \
#             --output-path=./lighthouse-report.json \
#             --chrome-flags="--headless --no-sandbox --disable-dev-shm-usage --ignore-certificate-errors --disable-features=BlockInsecurePrivateNetworkRequests"
#           PERFORMANCE=$(jq '.categories.performance.score * 100' lighthouse-report.json)
#           ACCESSIBILITY=$(jq '.categories.accessibility.score * 100' lighthouse-report.json)
#           BEST_PRACTICES=$(jq '.categories["best-practices"].score * 100' lighthouse-report.json)
#           SEO=$(jq '.categories.seo.score * 100' lighthouse-report.json)
#           echo "::set-output name=PERFORMANCE::$PERFORMANCE"
#           echo "::set-output name=ACCESSIBILITY::$ACCESSIBILITY"
#           echo "::set-output name=BEST_PRACTICES::$BEST_PRACTICES"
#           echo "::set-output name=SEO::$SEO"

#       - name: Show Lighthouse Scores in GitHub Actions log
#         run: |
#           echo "ğŸ† Lighthouse Scores:"
#           echo "ğŸš€ Performance: ${{ steps.extract_scores.outputs.PERFORMANCE }}"
#           echo "â™¿ Accessibility: ${{ steps.extract_scores.outputs.ACCESSIBILITY }}"
#           echo "ğŸ” SEO: ${{ steps.extract_scores.outputs.SEO }}"
#           echo "ğŸ”§ Best Practices: ${{ steps.extract_scores.outputs.BEST_PRACTICES }}"
